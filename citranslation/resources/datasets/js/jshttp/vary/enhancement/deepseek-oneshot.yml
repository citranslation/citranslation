```yaml
name: ci

on:
- pull_request
- push

jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node-version:
        - 0.8
        - 0.10
        - 0.12
        - 1.8
        - 2.5
        - 3.3
        - 4.9
        - 5.12
        - 6.17
        - 7.10
        - 8.17
        - 9.11
        - 10.24
        - 11.15
        - 12.22
        - 13.14
        - 14.21
        - 15.14
        - 16.20
        - 17.9
        - 18.18
        - 19.9
        - 20.9
        - 21.1
        - 22.0

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Configure npm
      run: |
        if [[ "$(npm config get package-lock)" == "true" ]]; then
          npm config set package-lock false
        else
          npm config set shrinkwrap false
        fi

    - name: Install npm module(s)
      run: |
        # Skip updating shrinkwrap / lock
        npm config set shrinkwrap false
        # Remove build dependencies
        npm rm --save-dev benchmark
        npm rm --save-dev beautify-benchmark
        # Setup Node.js version-specific dependencies
        # mocha for testing
        # - use 1.x for Node.js < 0.8
        # - use 2.x for Node.js < 0.10
        # - use 3.x for Node.js < 4
        # - use 5.x for Node.js < 6
        # - use 6.x for Node.js < 8
        # - use 7.x for Node.js < 10
        if [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -eq 0 && "$(cut -d. -f2 <<< "${{ matrix.node-version }}")" -lt 8 ]]; then
          npm install --save-dev mocha@1.21.5
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -eq 0 && "$(cut -d. -f2 <<< "${{ matrix.node-version }}")" -lt 10 ]]; then
          npm install --save-dev mocha@2.5.3
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 4 ]]; then
          npm install --save-dev mocha@3.5.3
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 6 ]]; then
          npm install --save-dev mocha@5.2.0
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 8 ]]; then
          npm install --save-dev mocha@6.2.2
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 10 ]]; then
          npm install --save-dev mocha@7.2.0
        fi
        # istanbul for coverage
        # - remove on Node.js < 0.10
        if [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -eq 0 && "$(cut -d. -f2 <<< "${{ matrix.node-version }}")" -lt 10 ]]; then
          npm rm --silent --save-dev istanbul
        fi
        # supertest for http calls
        # - use 1.1.0 for Node.js < 0.10
        # - use 2.0.0 for Node.js < 4
        # - use 3.4.2 for Node.js < 6
        if [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -eq 0 && "$(cut -d. -f2 <<< "${{ matrix.node-version }}")" -lt 10 ]]; then
          npm install --save-dev supertest@1.1.0
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 4 ]]; then
          npm install --save-dev supertest@2.0.0
        elif [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 6 ]]; then
          npm install --save-dev supertest@3.4.2
        fi
        # eslint for linting
        # - remove on Node.js < 10
        if [[ "$(cut -d. -f1 <<< "${{ matrix.node-version }}")" -lt 10 ]]; then
          node -pe 'Object.keys(require("./package").devDependencies).join("\n")' | \
            grep -E '^eslint(-|$)' | \
            xargs -n 1 npm rm --save-dev
        fi
        # Update Node.js modules
        # Prune and rebuild node_modules
        if [[ -d node_modules ]]; then
          npm prune
          npm rebuild
        fi

    - name: Run tests
      run: |
        # Run test script, depending on istanbul install
        if npm -ps ls istanbul | grep -q istanbul; then
          npm run-script test-travis
        else
          npm test
        fi
        # Run linting, depending on eslint install
        if npm -ps ls eslint | grep -q eslint; then
          npm run-script lint
        fi

    - name: Upload coverage to coveralls
      if: ${{ matrix.node-version == '10.24' }}
      run: |
        # Upload coverage to coveralls if exists
        if [[ -f ./coverage/lcov.info ]]; then
          npm install --save-dev coveralls@2
          coveralls < ./coverage/lcov.info
        fi
```
