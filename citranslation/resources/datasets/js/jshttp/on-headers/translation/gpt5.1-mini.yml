name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [
          "0.8",
          "0.10",
          "0.12",
          "1.8",
          "2.5",
          "3.3",
          "4.9",
          "5.12",
          "6.16",
          "7.10",
          "8.17",
          "9.11",
          "10.21",
          "11.15",
          "12.18",
          "13.14",
          "14.5"
        ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ matrix.node }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node }}-

      - name: Prepare environment and adjust devDependencies for node version
        shell: bash
        env:
          TRAVIS_NODE_VERSION: ${{ matrix.node }}
        run: |
          # Utility functions
          node_version_lt () {
            [[ "$(v "$TRAVIS_NODE_VERSION")" -lt "$(v "${1}")" ]]
          }
          npm_module_installed () {
            npm -lsp ls | grep -Fq "$(pwd)/node_modules/${1}:${1}@"
          }
          npm_remove_module_re () {
            node -e '
              fs = require("fs");
              p = JSON.parse(fs.readFileSync("package.json", "utf8"));
              r = RegExp(process.argv[1]);
              if (p.devDependencies) {
                for (k in p.devDependencies) {
                  if (r.test(k)) delete p.devDependencies[k];
                }
              }
              fs.writeFileSync("package.json", JSON.stringify(p, null, 2) + "\n");
            ' "$@"
          }
          npm_use_module () {
            node -e '
              fs = require("fs");
              p = JSON.parse(fs.readFileSync("package.json", "utf8"));
              if (!p.devDependencies) p.devDependencies = {};
              p.devDependencies[process.argv[1]] = process.argv[2];
              fs.writeFileSync("package.json", JSON.stringify(p, null, 2) + "\n");
            ' "$@"
          }
          v () {
            tr '.' '\n' <<< "${1}" \
              | awk '{ printf "%03d", $0 }' \
              | sed 's/^0*//'
          }

          # Configure npm (skip updating shrinkwrap / lock)
          npm config set shrinkwrap false

          # Configure mocha for testing
          if   node_version_lt '0.10'; then npm_use_module 'mocha' '2.5.3'
          elif node_version_lt '4.0' ; then npm_use_module 'mocha' '3.5.3'
          elif node_version_lt '6.0' ; then npm_use_module 'mocha' '5.2.0'
          elif node_version_lt '8.0' ; then npm_use_module 'mocha' '6.2.2'
          elif node_version_lt '10.0'; then npm_use_module 'mocha' '7.1.2'
          fi

          # Configure istanbul for coverage
          if node_version_lt '0.10'; then npm_remove_module_re '^istanbul$'; fi

          # Configure supertest for http calls
          if   node_version_lt '0.10'; then npm_use_module 'supertest' '1.1.0'
          elif node_version_lt '4.0' ; then npm_use_module 'supertest' '2.0.0'
          elif node_version_lt '6.0' ; then npm_use_module 'supertest' '3.4.2'
          fi

          # Configure eslint for linting
          if node_version_lt '8.0'; then npm_remove_module_re '^eslint(-|$)'; fi

          # Prune & rebuild node_modules (if present)
          if [[ -d node_modules ]]; then
            npm prune
            npm rebuild
          fi

      - name: Show installed modules (diagnostic)
        shell: bash
        run: npm -s ls || :

      - name: Run tests and lint
        shell: bash
        run: |
          npm_module_installed () {
            npm -lsp ls | grep -Fq "$(pwd)/node_modules/${1}:${1}@"
          }

          # Run test script, depending on istanbul install
          if npm_module_installed 'istanbul'; then
            npm run-script test-travis
          else
            npm test
          fi

          # Run linting, if eslint exists
          if npm_module_installed 'eslint'; then
            npm run-script lint
          fi

      - name: Upload coverage to Coveralls (if present)
        if: always()
        shell: bash
        run: |
          if [[ -e ./coverage/lcov.info ]]; then
            npm install --no-save coveralls@2
            npx coveralls < ./coverage/lcov.info
          fi
|End-of-Code|