name: Test Python and Django
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    env:
      DJANGO_VERSION: '3.2.23'
    services:
      - postgresql
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install . --use-mirrors
          pip install django==${{ env.DJANGO_VERSION }}
          pip install psycopg2
          python setup.py -q install
      - name: Setup PostgreSQL
        run: |
          # Wait for PostgreSQL to start
          until psql -U postgres -c 'SELECT 1'; do
            sleep 1
          done
          psql -c 'create database test;' -U postgres
          psql -d test -c 'create extension cube;' -U postgres
          psql -d test -c 'create extension earthdistance;' -U postgres
      - name: Run tests
        run: python runtests.py
|End-of-Code|