```yaml
name: Python application

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Cache pip
      uses: actions/cache@v2
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/poetry.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Install Poetry
      run: pip install poetry
    - name: Install dependencies
      run: poetry install
    - name: Run tests with coverage
      run: poetry run coverage run -m pytest -v
    - name: Upload coverage to Codecov
      run: codecov

  deploy:
    needs: build
    if: startsWith(github.ref, 'refs/tags')
    runs-on: ubuntu-latest
    steps:
    - name: Set PYPI_TOKEN
      run: echo "PYPI_TOKEN=${{ secrets.POETRY_PYPI_TOKEN_PYPI }}" >> $GITHUB_ENV
    - name: Publish package
      run: poetry config pypi-token.pypi ${{ env.PYPI_TOKEN }} && poetry publish --no-interaction --build
```
