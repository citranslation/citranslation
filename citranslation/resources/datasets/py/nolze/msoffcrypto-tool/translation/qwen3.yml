name: CI
on:
  push:
    branches:
      - master
    tags: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Cache pip
        uses: actions/cache@v2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install Poetry and codecov
        run: pip install poetry codecov
      - name: Install dependencies
        run: poetry install
      - name: Run tests
        run: poetry run coverage run -m pytest -v
      - name: Upload coverage
        run: codecov

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' || github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install Poetry
        run: pip install poetry
      - name: Configure PyPI token
        run: poetry config pypi-token.pypi "${{ secrets.PYPI_TOKEN }}"
      - name: Publish to PyPI
        run: poetry publish --no-interaction --build
|End-of-Code|