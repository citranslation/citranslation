name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      dynamodb:
        image: amazon/dynamodb-local
        ports:
          - 8000:8000
        options: >-
          --network=host
          -e "DYNAMODB_PORT=8000"
          -e "DYNAMODB_HOST=localhost"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8

      - name: Run flake8
        run: flake8 --ignore=E501,W504

      - name: Prepare dump directory
        run: mkdir dump && cp -a test/testTable dump

      - name: Test basic restore and backup
        run: |
          python dynamodump.py -m restore -r local -s testTable -d testRestoredTable --host localhost --port 8000 --accessKey a --secretKey a
          python dynamodump.py -m backup -r local -s testRestoredTable --host localhost --port 8000 --accessKey a --secretKey a
          python test/test.py

      - name: Test wildcard restore and backup
        run: |
          python dynamodump.py -m restore -r local -s "*" --host localhost --port 8000 --accessKey a --secretKey a
          rm -rf dump/test*
          python dynamodump.py -m backup -r local -s "*" --host localhost --port 8000 --accessKey a --secretKey a
          python test/test.py

      - name: Test prefixed wildcard restore and backup
        run: |
          python dynamodump.py -m restore -r local -s "test*" --host localhost --port 8000 --accessKey a --secretKey a --prefixSeparator ""
          rm -rf dump/test*
          python dynamodump.py -m backup -r local -s "test*" --host localhost --port 8000 --accessKey a --secretKey a --prefixSeparator ""
          python test/test.py

