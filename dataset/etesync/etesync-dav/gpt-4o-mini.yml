name: CI

on:
  push:
    tags:
      - '*'

jobs:
  linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: [3.8]
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip pyinstaller wheel
          pip install -r requirements.txt .

      - name: Run script
        run: |
          cd pyinstaller && ./bundle.sh

  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run script
        run: |
          cd pyinstaller && ./bundle.sh

  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Python 3.8.0
        run: |
          choco install python --version 3.8.0
          python -m pip install --upgrade pip

      - name: Set PATH
        run: echo "PATH=C:\\Python38;C:\\Python38\\Scripts;%PATH%" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          pip install --upgrade pip pyinstaller wheel
          pip install -r requirements.txt .

      - name: Run script
        run: |
          cd pyinstaller && ./bundle.sh

  deploy:
    runs-on: ubuntu-latest
    needs: [linux, macos, windows]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag: ${{ github.ref }}
          files: deploy/*
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

